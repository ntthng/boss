<!-- GIỮ NGUYÊN PHẦN HTML CỦA BẠN -->

<!-- THAY THẾ CHỈ PHẦN renderTable() DƯỚI ĐÂY -->
<script>
  function renderTable() {
    const tbody = document.getElementById("bossBody");
    tbody.innerHTML = "";
    const now = new Date();
    const isSort = document.getElementById("toggleSort").checked;
    const searchText = document.getElementById("searchInput").value.toLowerCase();

    let data = bossList.map((b, i) => {
      const kill = loadTime(i);
      let last = kill ? new Date(kill) : null;
      let next = null;

      if (last && b.respawn) {
        const delay = getDelay(b.level);
        do {
          next = new Date(last.getTime() + b.respawn * 3600000 + delay * 60000);
          last = new Date(next);
        } while (next < now);
      }

      return { ...b, index: i, killTime: kill ? new Date(kill) : null, respawnTime: next };
    });

    data = data.filter(b => b.name.toLowerCase().includes(searchText));
    if (isSort) {
      const withRespawn = data.filter(b => b.respawnTime).sort((a, b) => a.respawnTime - b.respawnTime);
      const withoutRespawn = data.filter(b => !b.respawnTime);
      data = [...withRespawn, ...withoutRespawn];
    }

    for (const boss of data) {
      const tr1 = document.createElement("tr");
      const tr2 = document.createElement("tr");
      if (boss.respawnTime && boss.respawnTime <= now) tr1.classList.add("spawned");

      tr1.innerHTML = `
        <td><b>${boss.zone}</b></td>
        <td><b>${boss.location}</b></td>
        <td><b>${boss.name}</b></td>
        <td><b>${boss.level}</b></td>
        <td><b>${boss.respawn > 0 ? boss.respawn + " giờ" : "-"}</b></td>
      `;

      const td = document.createElement("td");
      td.colSpan = 5;

      const wrapper = document.createElement("div");
      wrapper.style.display = "flex";
      wrapper.style.justifyContent = "space-between";
      wrapper.style.alignItems = "center";
      wrapper.style.flexWrap = "wrap";
      wrapper.style.gap = "10px";

      const killDiv = document.createElement("div");
      killDiv.style.display = "flex";
      killDiv.style.alignItems = "center";
      killDiv.style.gap = "6px";
      const killLabel = document.createElement("label");
      killLabel.innerHTML = "<b>Tiêu diệt:</b>";
      const input = document.createElement("input");
      input.type = "datetime-local";
      input.value = boss.killTime ? new Date(boss.killTime.getTime() - boss.killTime.getTimezoneOffset() * 60000).toISOString().slice(0, 16) : "";
      input.onchange = () => saveTime(boss.index, input.value);
      killDiv.appendChild(killLabel);
      killDiv.appendChild(input);

      const respawnDiv = document.createElement("div");
      respawnDiv.innerHTML = `<b>Hồi sinh: ${boss.respawnTime ? formatDateTime(boss.respawnTime) : "-"}</b>`;

      const btnDiv = document.createElement("div");
      btnDiv.style.display = "flex";
      btnDiv.style.gap = "6px";
      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-btn";
      copyBtn.textContent = "Copy";
      copyBtn.onclick = () => copyLog(boss.name, boss.location, boss.respawnTime ? formatDateTime(boss.respawnTime) : "-");
      const clearBtn = document.createElement("button");
      clearBtn.className = "clear-btn";
      clearBtn.textContent = "Xóa";
      clearBtn.onclick = () => clearTime(boss.index);
      btnDiv.appendChild(copyBtn);
      btnDiv.appendChild(clearBtn);

      wrapper.appendChild(killDiv);
      wrapper.appendChild(respawnDiv);
      wrapper.appendChild(btnDiv);
      td.appendChild(wrapper);

      // Checkbox toggle
      const toggleWrap = document.createElement("div");
      toggleWrap.className = "history-toggle";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = "historyToggle_" + boss.index;
      checkbox.onchange = () => toggleHistory(boss.index);
      const label = document.createElement("label");
      label.htmlFor = checkbox.id;
      label.textContent = "Lịch sử tiêu diệt";
      toggleWrap.appendChild(checkbox);
      toggleWrap.appendChild(label);

      td.appendChild(toggleWrap);

      // History list
      const historyList = document.createElement("ul");
      historyList.id = "historyList_" + boss.index;
      historyList.className = "history-list";

      loadHistory(boss.index).forEach(h => {
        const li = document.createElement("li");
        li.textContent = formatDateTime(new Date(h));
        historyList.appendChild(li);
      });

      td.appendChild(historyList);

      tr2.appendChild(td);
      tbody.appendChild(tr1);
      tbody.appendChild(tr2);
    }
  }
</script>
